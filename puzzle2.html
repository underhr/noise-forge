<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simon Says Puzzle</title>
<style>
  body {
    margin:0;
    font-family: sans-serif;
    background: url('assets/images/stone_wall.png') no-repeat center center fixed;
    background-size: cover;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    transition: opacity 1s ease; /* fade transition */
  }

  body.fade-out {
    opacity: 0;
  }

  #fade-wrapper {
    opacity: 0;
    transition: opacity 1s ease;
  }

  #fade-wrapper.fade-in {
    opacity: 1;
  }

  #game-container {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #central-rhombus {
    width: 550px;
    height: 550px;
    background-image: url('simon_central.png');
    background-size: contain;
    background-repeat: no-repeat;
    position: relative;
    margin-bottom: 50px;
  }

  .highlight {
    position: absolute;
    width: 240px;
    height: 240px;
    background-size: contain;
    background-repeat: no-repeat;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s ease;
  }

  /* Correct positions relative to central rhombus */
  .highlight.mic { top: 22%; left: 52%; transform: translate(-50%, -50%); }
  .highlight.guitar { top: 45%; right: 35%; transform: translate(50%, -50%); }
  .highlight.drums { bottom: 50%; left: 58%; transform: translate(-50%, 50%); }
  .highlight.keyboard { top: 40%; left: 34%; transform: translate(-50%, -50%); }

  #button-container {
    display: flex;
    justify-content: center;
    gap: 20px;
  }

  /* clean button style, no overlay */
  .simon-button {
    width: 80px;
    height: 80px;
    background-color: transparent;
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center;
    border: none;
    outline: none;
    box-shadow: none;
    cursor: pointer;
    transition: transform 0.1s ease;
  }

  .simon-button:active {
    transform: scale(0.9);
  }

  .simon-button:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }

  #message {
    color: white;
    margin-top: 20px;
    font-size: 1.2rem;
    text-align: center;
  }

  #stage-indicator {
    color: white;
    margin-top: 10px;
    font-size: 1rem;
  }

  #volume-control {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0,0,0,0.6);
    padding: 8px 12px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    z-index: 9999;
  }

  #volume-slider {
    vertical-align: middle;
    margin-left: 8px;
  }
</style>
</head>
<body>

<div id="fade-wrapper">

  <div id="game-container">
    <div id="central-rhombus">
      <div class="highlight mic" id="highlight-mic" style="background-image:url('mic.gif');"></div>
      <div class="highlight guitar" id="highlight-guitar" style="background-image:url('guitar.gif');"></div>
      <div class="highlight drums" id="highlight-drums" style="background-image:url('drums.gif');"></div>
      <div class="highlight keyboard" id="highlight-keyboard" style="background-image:url('keyboard.gif');"></div>
    </div>

    <div id="button-container">
      <button class="simon-button" data-sound="mic" style="background-image:url('assets/images/mic_button.png')"></button>
      <button class="simon-button" data-sound="guitar" style="background-image:url('assets/images/guitar_button.png')"></button>
      <button class="simon-button" data-sound="drums" style="background-image:url('assets/images/drums_button.png')"></button>
      <button class="simon-button" data-sound="keyboard" style="background-image:url('assets/images/keyboard_button.png')"></button>
    </div>

    <div id="message">The chamber listens...</div>
    <div id="stage-indicator">Stage 1 of 3</div>
  </div>

</div>

<!-- ðŸ”Š Volume slider -->
<div id="volume-control">
  ðŸ”Š
  <input type="range" id="volume-slider" min="0" max="1" step="0.01">
</div>

<script>
/* ===================== CONFIG ===================== */
const maxStages = 3;
const baseSequenceLength = 4;
let currentStage = 1;
let sequenceLength = baseSequenceLength;

/* ===================== STATE ===================== */
let pattern = [];
let currentStep = 0;
let acceptingInput = false;

/* ===================== ELEMENTS ===================== */
const messageEl = document.getElementById("message");
const stageEl = document.getElementById("stage-indicator");

const highlights = {
  mic: document.getElementById('highlight-mic'),
  guitar: document.getElementById('highlight-guitar'),
  drums: document.getElementById('highlight-drums'),
  keyboard: document.getElementById('highlight-keyboard')
};

const buttons = document.querySelectorAll('.simon-button');

/* ===================== SOUND SETUP ===================== */
const sounds = {
  mic: new Audio('assets/audio/mic.mp3'),
  guitar: new Audio('assets/audio/guitar.mp3'),
  drums: new Audio('assets/audio/drums.mp3'),
  keyboard: new Audio('assets/audio/keyboard.mp3')
};

// ðŸ”¹ load saved volume
const savedVolume = localStorage.getItem('simonVolume');
let volume = savedVolume !== null ? parseFloat(savedVolume) : 0.5;
for(let key in sounds) sounds[key].volume = volume;

// ðŸ”¹ volume slider
const slider = document.getElementById('volume-slider');
slider.value = volume;
slider.addEventListener('input', ()=>{
  volume = slider.value;
  for(let key in sounds) sounds[key].volume = volume;
  localStorage.setItem('simonVolume', volume);
});

/* ===================== FADE IN ===================== */
window.addEventListener("load", () => {
  document.getElementById("fade-wrapper").classList.add("fade-in");
  updateStageText();
  setTimeout(() => {
    generatePattern();
    showPattern();
  }, 1000);
});

/* ===================== HELPERS ===================== */
function updateStageText(){
  stageEl.textContent = `Stage ${currentStage} of ${maxStages}`;
}

function generatePattern() {
  const keys = Object.keys(highlights);
  pattern = [];
  for(let i = 0; i < sequenceLength; i++){
    pattern.push(keys[Math.floor(Math.random() * keys.length)]);
  }
}

function wait(ms){
  return new Promise(resolve => setTimeout(resolve, ms));
}

/* ===================== SHOW PATTERN ===================== */
async function showPattern() {
  acceptingInput = false;
  currentStep = 0;
  messageEl.textContent = "Watch the pattern...";

  for(let key of pattern){
    highlights[key].style.opacity = 1;
    sounds[key].currentTime = 0;
    sounds[key].play();
    await wait(600);
    highlights[key].style.opacity = 0;
    await wait(250);
  }

  messageEl.textContent = "Your turn...";
  acceptingInput = true;
}

/* ===================== PLAYER INPUT ===================== */
buttons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(!acceptingInput) return;

    const key = btn.dataset.sound;

    highlights[key].style.opacity = 1;
    sounds[key].currentTime = 0;
    sounds[key].play();
    setTimeout(()=>highlights[key].style.opacity=0,300);

    if(key !== pattern[currentStep]){
      acceptingInput = false;
      messageEl.textContent = "The rhythm breaks...";
      setTimeout(()=>{
        generatePattern();
        showPattern();
      }, 1200);
      return;
    }

    currentStep++;

    if(currentStep === pattern.length){
      acceptingInput = false;

      if(currentStage < maxStages){
        currentStage++;
        sequenceLength += 2;
        updateStageText();
        messageEl.textContent = "The harmony deepens...";
        setTimeout(()=>{
          generatePattern();
          showPattern();
        }, 1400);

      } else {
        messageEl.textContent = "The harmony is complete.";

        // ðŸ”’ disable all buttons before fade
        buttons.forEach(b => b.disabled = true);

        // ðŸ”¹ fade out to next puzzle
        document.body.classList.add("fade-out");

        setTimeout(() => {
          window.location.href = "puzzle3.html";
        }, 1000);
      }
    }
  });
});
</script>
</body>
</html>
